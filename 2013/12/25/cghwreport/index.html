
<!DOCTYPE html>
<html lang="en">
  <head>
    

    <meta charset="utf-8">
    <title>
      
        图形学大作业文档 - 
      
      
        CJLD
      
    </title>
    
    <meta name="author" content="cjld">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- HTML5 shim, for IE6-8 support of HTML elements -->
    <!--[if lt IE 9]>
      <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->


    <link href="/assets/themes/hooligan/bootstrap/css/bootstrap.min.css" rel="stylesheet">
    <link href="/assets/themes/hooligan/bootstrap/css/bootstrap-responsive.min.css" rel="stylesheet">    
    <link rel="stylesheet" type="text/css" href="/assets/themes/hooligan/css-social-buttons/css/zocial.stripped.css">
    <link href="/assets/themes/hooligan/css/pygments.css" rel="stylesheet" type="text/css" media="all">
    <link href="/assets/themes/hooligan/css/darkstrap.css" rel="stylesheet" type="text/css" media="all">    
    <link href="/assets/themes/hooligan/css/style.css?body=1" rel="stylesheet" type="text/css" media="all">
    <link href="/assets/themes/hooligan/css/mystyle.css" rel="stylesheet" type="text/css" media="all">    
    <link href="/assets/themes/hooligan/google-code-prettify/doxy.css" rel="stylesheet" type="text/css" media="all">

    
    <!-- fav and touch icons -->
  <!-- Update these with your own images
    <link rel="shortcut icon" href="images/favicon.ico">
    <link rel="apple-touch-icon" href="images/apple-touch-icon.png">
    <link rel="apple-touch-icon" sizes="72x72" href="images/apple-touch-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="114x114" href="images/apple-touch-icon-114x114.png">
  -->
  </head>

  <body>
    <div class="navbar">
      <div class="navbar-inner">
        <div class="container">
          <!-- .btn-navbar is used as the toggle for collapsed navbar content -->
          <a class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </a>      


          <a class="brand" href="/">CJLD</a>


          <div class="nav-collapse">
            <ul class="nav">
              
              
              


  
    
      
      	
      	<li><a href="/about.html">关于</a></li>
      	
      
    
  
    
      
      	
      	<li><a href="/archive.html">文章</a></li>
      	
      
    
  
    
      
    
  
    
      
    
  
    
      
    
  
    
      
      	
      	<li><a href="/rss.xml">订阅</a></li>
      	
      
    
  
    
      
      	
      	<li><a href="/sand.html">零散</a></li>
      	
      
    
  
    
      
    
  
    
      
      	
      	<li><a href="/tags.html">标签</a></li>
      	
      
    
  
    
      
    
  



            </ul>
            <ul class="nav pull-right social visible-desktop">
              <li class="divider-vertical"></li>
              
                <li>
                  <a href="https://github.com/cjld" class="zocial github icon" target="_blank">
                    <span class="hidden-desktop">Github</span>
                  </a>
                </li>
              
                  
                                        
                         
                                  
              
            </ul>
          </div>
        </div>
      </div>
    </div>

    <div class="container">
      <div class="content">
        
<div class="page-header">
  <h1 id="mainTitle">
    图形学大作业文档 
    
  </h1>
</div>

<div class="row">
  
  <div class="span4">
    <section>
    <h3><i class="icon-calendar"></i>Published</h3>
      <div class="date"><span style="margin-left: 20px">25 December 2013</span></div>
    </section>
         
    
      <section id="tags_box">
        <h3><i class="icon-tags"></i>Tags</h3>
        <ul class="tag_box" style="margin-left: 20px">
          
          


  
     
    	<li><a href="/tags.html#CG-ref">CG <span>2</span></a></li>
    
  



        </ul>
      </section>
       
      <section id="contents">
        <h3><i class="icon-th-list"></i>Contents</h3>
        <div id="content_box">
        </div>
      </section>
  </div>


  <div class="span8">
    <div id="content">
      <p>图形学大作业奋战了将近一个月，算是告一段落了，虽然还有很多想写的特性，但是落下了一堆功课得赶紧补了。</p>
<p>参考了不少文章，最后效果还凑活，没有网上一些图片精致，从zsyzgu同学翻译的文章<a href="http://hi.baidu.com/zsyzgu/archive/tag/%E5%85%89%E7%BA%BF%E8%BF%BD%E8%B8%AA">4</a>那参考了不少，这位同学今年参加了智能体，很是欣慰~</p>
<p>下面是大作业的文档，放上来凑数</p>
<h2 id="基本信息">1. 基本信息</h2>
<h3 id="作业内容">1.1. 作业内容</h3>
<p>实现光线跟踪以及网格简化。</p>
<h3 id="测试设备">1.2. 测试设备</h3>
<ul>
<li>系统 : Windows 8</li>
<li>CPU : I5-3230M 2.60GHz</li>
<li>GPU : GT 750M</li>
</ul>
<h3 id="实现内容及特性">1.3. 实现内容及特性</h3>
<ul>
<li><p>边压缩的网格简化，下图从左到右依次为 100、300、500、700、900个三角形</p>
<figure>
<img src="../../../../img/cghwimg/1.png" />
</figure></li>
<li><p>支持 .obj 格式以及 .mtl 材质格式读入， 支持 UV 贴图， 支持法相平滑插值和位置插值，下图为对比效果图。</p>
<p><img src="../../../../img/cghwimg/2.png" /> <img src="../../../../img/cghwimg/3.png" /></p></li>
<li><p>SAH-KDTree 加速</p>
<p>图中为968个三角形的模型，关闭阴影和抗锯齿，单线程耗时90ms，多线程耗时 40ms.</p>
<figure>
<img src="../../../../img/cghwimg/4.png" />
</figure>
<p>KdTree 网格划分情况，绿色为叶节点，红色为中间节点。</p>
<figure>
<img src="../../../../img/cghwimg/5.png" />
</figure></li>
<li><p>OpenCL 显卡加速，KDTree遍历代码以及RayTrace递归过程 改非递归重写, 非递归KDTree部分参考自论文<a href="http://www.mpi-inf.mpg.de/~guenther/StacklessGPURT/">3</a>。 因为从CPU传参数到GPU需要一定时间，所以使用较为复杂的场景，并且开启阴影和三个光源，效果如下图：</p>
<figure>
<img src="../../../../img/cghwimg/6.png" />
</figure>
<p>其中 CPU 单线程运算耗时5970ms， 多线程耗时为2698ms，OpenCL GPU耗时830ms</p></li>
<li><p>快速抗锯齿</p>
<p>下左图为未抗锯齿抗锯齿，右图为抗锯齿</p>
<p><img src="../../../../img/cghwimg/7.png" /> <img src="../../../../img/cghwimg/8.png" /></p></li>
<li><p>软阴影以及BRDF</p>
<p><img src="../../../../img/cghwimg/9.png" /> <img src="../../../../img/cghwimg/10.png" /></p></li>
<li><p>红蓝3D</p>
<figure>
<img src="../../../../img/cghwimg/11.png" />
</figure></li>
</ul>
<h2 id="实现原理">2. 实现原理</h2>
<h3 id="网格简化">2.1. 网格简化</h3>
<p>已有一个三角网格，每次选一条最短的边然后将这条边所连的两个点合并，并删除重边。</p>
<p>两个点合并以后产生一个新的点，这个点由这两个点的坐标以及这两个点的法向量二次插值计算得来，插值方法如下：</p>
<pre><code>Xa Xb : a, b 的坐标
Fa Fb : a, b 的点法向量，由这个点附近的面的法向量插值得来
Normal(x) : 将 x 归一化
X = (a + b)/2 + Normal(Fa + Fb) * dot((Xa - Xb), Fa - Fb) / 4</code></pre>
<p>这样可以得到 C1 连续的顶点，如图所示</p>
<figure>
<img src="../../../../img/cghwimg/12.png" />
</figure>
<h3 id="光线跟踪">2.2. 光线跟踪</h3>
<h4 id="sah-kdtree">2.2.1. SAH-KDTree</h4>
<p>和普通 KDTree 不一样的是， SAH-KDTree 通过一个函数加权计算划分点。 具体参考论文<a href="http://www.eng.utah.edu/~cs6965/papers/kdtree.pdf">1</a>.</p>
<h4 id="软阴影">2.2.2. 软阴影</h4>
<p>自然生活中，阴影的边缘多半是模糊的，这是因为光源并非点光源而是面光源，那么如何计算面光源，解析计算难度很大，有一个粗暴的方法是在这个面光源上随机取一个点， 然后把它当做点光源，这个方法显然太粗暴，于是乎可以将这个面划分成更多小面，比如4*4个小面，然后每个小面单独做在加权起来，如下图所示， 参考自网站<a href="http://www.flipcode.com/archives/Raytracing_Topics_Techniques-Part_5_Soft_Shadows.shtml">2</a>。</p>
<figure>
<img src="../../../../img/cghwimg/13.png" />
</figure>
<h4 id="蒙特卡洛光线跟踪">2.2.3. 蒙特卡洛光线跟踪</h4>
<p>蒙特卡洛光线跟踪可以对一些BRDF模型进行计算, 其思想和生成软阴影的方法有些类似， 参考自网站<a href="http://www.flipcode.com/archives/Raytracing_Topics_Techniques-Part_5_Soft_Shadows.shtml">2</a>。</p>
<h4 id="红蓝3d">2.2.4. 红蓝3D</h4>
<p>这个挺简单的，就是在两只不同的眼睛生成两张不同的图片，然后在合并起来。 合并算法就是对于一个像素，红色分量取左眼的图片，蓝绿色色分量取右眼的图片。</p>
<h4 id="快速抗锯齿">2.2.5. 快速抗锯齿</h4>
<p>对于一张锯齿严重的图，抗锯齿是必须的，为什么会有锯齿的出现， 这是因为每个像素发射一条射线不足以描述这一个像素的颜色，为了采样这个像素的颜色，我们可以多发射几条射线。</p>
<p>但是对于一张图，并不是所有像素都有重新采样的需求，比如我们可以对图像的边缘进行采样，有方法是，如果这个像素和附近的像素打到了不同的三角形上，那么对这个点进行采样，参考自网站<a href="http://www.flipcode.com/archives/Raytracing_Topics_Techniques-Part_5_Soft_Shadows.shtml">2</a>， 如图：</p>
<figure>
<img src="../../../../img/cghwimg/14.png" />
</figure>
<p>对于一些特别精细的模型这个采样方法可能还不够高效，我们再计算下这个图像的梯度：</p>
<figure>
<img src="../../../../img/cghwimg/15.png" />
</figure>
<p>然后同时满足第一个条件和梯度大于阈值时才对这个点进行采样，如下图：</p>
<figure>
<img src="../../../../img/cghwimg/16.png" />
</figure>
<h2 id="实现过程">3. 实现过程</h2>
<h3 id="section">2013.12.4</h3>
<ul>
<li>三角形求交，使用纯色进行着色</li>
</ul>
<h3 id="section-1">2013.12.5</h3>
<ul>
<li>Lambert着色，phong着色</li>
</ul>
<h3 id="section-2">2013.12.6</h3>
<ul>
<li>使用极坐标分段三角片模拟球</li>
<li>插值法向量，对模型做平滑处理平滑</li>
<li>阴影的计算</li>
</ul>
<h3 id="section-3">2013.12.7</h3>
<ul>
<li>可读取 obj 文件进行渲染</li>
<li>代码重构</li>
<li>实现反射与折射</li>
</ul>
<h3 id="section-4">2013.12.8</h3>
<ul>
<li>实现 sah-kdtree 建树</li>
<li>kdtree 线框图用于对kdtree进行分析</li>
</ul>
<h3 id="section-5">2013.12.10</h3>
<ul>
<li>实现 kdtree 加速光线跟踪</li>
</ul>
<h3 id="section-6">2013.12.13</h3>
<ul>
<li>CPU 多线程实现</li>
<li>实现快速抗锯齿</li>
</ul>
<h3 id="section-7">2013.12.14</h3>
<ul>
<li>支持 obj 以及 mtl 材质文件</li>
<li>支持阴影色，实现“假”焦散效果 <img src="../../../../img/cghwimg/17.png" /></li>
</ul>
<h3 id="section-8">2013.12.15</h3>
<ul>
<li>支持了纹理，支持 UV 贴图</li>
</ul>
<h3 id="section-9">2013.12.20</h3>
<ul>
<li>实现了非递归 kdtree 的遍历</li>
<li>通过位置插值来计算更加精确的阴影</li>
</ul>
<h3 id="section-10">2013.12.21</h3>
<ul>
<li>实现 OpenCL 的移植， 比CPU多线程有5倍的提速</li>
</ul>
<h3 id="section-11">2013.12.22</h3>
<ul>
<li>实现显卡抗锯齿</li>
<li>光源衰减，让光源按照距离的平方项的倒数衰减</li>
<li>啤酒瓶定理和菲涅尔项更好的渲染折射以及反射</li>
</ul>
<h3 id="section-12">2013.12.23</h3>
<ul>
<li>实现面光源，软阴影</li>
<li>蒙特卡洛光线跟踪计算BRDF</li>
<li>循环队列广搜光线跟踪</li>
<li>红蓝3D</li>
</ul>
<h3 id="section-13">2013.12.25</h3>
<ul>
<li>网格简化</li>
</ul>
<h2 id="参考文献">4. 参考文献</h2>
<p>以下链接对我帮助很大，特此感谢~</p>
<ul>
<li><a href="http://www.eng.utah.edu/~cs6965/papers/kdtree.pdf">[1] On building fast kd-Trees for Ray Tracing, and on doing that in O(N log N)</a></li>
<li><a href="http://www.flipcode.com/archives/Raytracing_Topics_Techniques-Part_5_Soft_Shadows.shtml">[2] Raytracing Topics &amp; Techniques - Part 5: Soft Shadows</a></li>
<li><a href="http://www.mpi-inf.mpg.de/~guenther/StacklessGPURT/">[3] Stackless KD-Tree Traversal for High Performance GPU Ray Tracing</a></li>
<li><a href="http://hi.baidu.com/zsyzgu/archive/tag/%E5%85%89%E7%BA%BF%E8%BF%BD%E8%B8%AA">zsyzgu同学翻译的[1]</a></li>
<li>几个学长的光线追踪
<ul>
<li>贾开学长的报告</li>
<li><a href="http://www.zxytim.com/%E5%85%89%E7%BA%BF%E8%B7%9F%E8%B8%AA%E5%BC%95%E6%93%8E-maskray-%E7%AC%94%E8%AE%B0/">http://www.zxytim.com/%E5%85%89%E7%BA%BF%E8%B7%9F%E8%B8%AA%E5%BC%95%E6%93%8E-maskray-%E7%AC%94%E8%AE%B0/</a></li>
<li><a href="http://www.ppwwyyxx.com/2013/More-On-Ray-Tracing/">http://www.ppwwyyxx.com/2013/More-On-Ray-Tracing/</a></li>
</ul></li>
</ul>

    </div>
    <hr>
    <div class="pagination btn-group">
      
        <a class="btn prev" href="/2013/11/26/crazyheap" title="若干丧心病狂的平衡树">&larr; Previous</a>
      
        <a class="btn" href="/archive.html">Archive</a>
      
        <a class="btn next" href="/2013/12/30/pandoctest" title="Blog 折腾">Next &rarr;</a>
      
    </div>
    <hr>
    


  

<div id="disqus_thread"></div>
<script type="text/javascript">
    var disqus_developer = 1;
    var disqus_shortname = 'cjldblog'; // required: replace example with your forum shortname
    
    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">blog comments powered by <span class="logo-disqus">Disqus</span></a>






  </div>
  
</div>


      </div>

      <footer>
        <p>&copy; 2015 cjld
          with help from <a href="http://jekyllbootstrap.com" target="_blank" title="The Definitive Jekyll Blogging Framework">Jekyll Bootstrap</a>
          and <a href="http://github.com/dhulihan/hooligan" target="_blank">The Hooligan Theme</a>
        </p>
      </footer>
    </div> <!-- /container -->

    <script src="//ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>
    <script>window.jQuery || document.write('<script src="/assets/themes/hooligan/js/jquery.min.js"><\/script>')</script>
    <script type="text/javascript" src="/assets/themes/hooligan/js/gen_content.js"></script>
    <script src="/assets/themes/hooligan/bootstrap/js/bootstrap.min.js"></script>
    <script type="text/javascript" src="/assets/themes/hooligan/google-code-prettify/prettify.js"></script>
    <script type="text/javascript"
      src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
    </script>
    <script type="text/javascript">
      $(document).ready(function(){
           $("pre").addClass("prettyprint");
           prettyPrint();
      })
    </script>
    

    
  </body>
</html>

